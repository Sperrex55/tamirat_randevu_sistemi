{% extends "base_technician.html" %}

{% block title %}Mesajlar{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='technician_messages.css') }}" />
{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;">
      {% for category, message in messages %}
        <div class="toast align-items-center text-bg-{{ category }} border-0 show mb-2">
          <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="user-list-container">
  
<!-- Sol panel: WhatsApp tarzÄ± kullanÄ±cÄ± listesi -->
<div class="user-list-wrapper">
  <div class="user-search">
    <input type="text" id="userSearchInput" placeholder="KullanÄ±cÄ± ara..." />
  </div>
  <ul class="user-list" id="userListUl">
    {% for entry in users_data %}
      {% set user = entry.user %}
      {% set last_message = entry.last_message %}
      {% set unread_count = entry.unread_count %}
      <li class="user-list-item" data-user-id="{{ user.id }}" data-user-name="{{ user.ad }} {{ user.soyad }}">
        <div class="user-info-left">
          <div class="avatar" title="{{ user.ad }} {{ user.soyad }}">
            {{ user.ad[0]|upper }}{{ user.soyad[0]|upper }}
          </div>
          <div class="user-info">
            <div class="user-name" title="{{ user.ad }} {{ user.soyad }}">
              {{ user.ad }} {{ user.soyad }}
            </div>
            <div class="user-last-message" title="{% if last_message %}{{ last_message.body }}{% else %}HenÃ¼z mesaj yok{% endif %}">
              {% if last_message %}
                {% if last_message.sender_type == 'technician' %}
                  {{ last_message.body[:35] ~ ('...' if last_message.body|length > 35 else '') }}
                {% else %}
                  Sen: {{ last_message.body[:35] ~ ('...' if last_message.body|length > 35 else '') }}
                {% endif %}
              {% else %}
                HenÃ¼z mesaj yok
              {% endif %}
            </div>
          </div>
        </div>
        <div class="user-info-right">
          <span class="user-time">
            {% if last_message %}
              {{ last_message.created_at.strftime('%H:%M') }}
            {% else %}
              --:--
            {% endif %}
          </span>
          {% if unread_count > 0 %}
            <span class="user-unread-badge">{{ unread_count }}</span>
          {% else %}
            <span class="user-unread-badge d-none">0</span>
          {% endif %}
          <button class="btn-send-message" data-user-id="{{ user.id }}" data-user-name="{{ user.ad }} {{ user.soyad }}" title="Mesaj gÃ¶nder">
            <i class="bi bi-send-fill"></i>
          </button>
        </div>
      </li>
    {% endfor %}
  </ul>
</div>




  <!-- SaÄŸ taraf: Chat alanÄ± -->
  <div class="chat-area">
    <div class="chat-header" id="chatWithTitle">
      <span>Bir kullanÄ±cÄ± seÃ§in</span>
      <button type="button" class="close-chat-btn" id="closeChatBtn" aria-label="Sohbeti Kapat">&times;</button>
    </div>

    <div class="message-list" id="messageList">
     <div class="empty-placeholder">
  <div class="placeholder-icon">ğŸ’¬</div>
  <div class="placeholder-text">
    KullanÄ±cÄ± seÃ§ildiÄŸinde mesajlar burada gÃ¶rÃ¼necek.
  </div>
</div>

    </div>

    <form id="chatInputForm" class="chat-input-area" style="display:none;" novalidate>
      <textarea id="chatInput" placeholder="Mesaj yazÄ±n..." rows="1" required></textarea>
      <button type="submit" disabled><i class="bi bi-send-fill"></i></button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
(() => {
  const socket = io();

  const userSearchInput = document.getElementById('userSearchInput');
  const userListUl = document.getElementById('userListUl');
  const messageListDiv = document.getElementById('messageList');
  const chatWithTitle = document.getElementById('chatWithTitle').querySelector('span');
  const closeChatBtn = document.getElementById('closeChatBtn');
  const chatInputForm = document.getElementById('chatInputForm');
  const chatInput = document.getElementById('chatInput');
  const chatSendBtn = chatInputForm.querySelector('button[type="submit"]');

  let activeUserId = null;
  let activeUserName = null;

  // KullanÄ±cÄ± arama
  userSearchInput.addEventListener('input', () => {
    const filter = userSearchInput.value.toLowerCase();
    userListUl.querySelectorAll('.user-list-item').forEach(item => {
      item.style.display = item.dataset.userName.toLowerCase().includes(filter) ? '' : 'none';
    });
  });

  // KullanÄ±cÄ± seÃ§imi
  userListUl.querySelectorAll('.user-list-item').forEach(item => {
    item.addEventListener('click', () => {
      const userId = item.dataset.userId;
      const userName = item.dataset.userName;
      if(activeUserId === userId) return;
      setActiveUser(userId, userName);
    });
  });

  function setActiveUser(userId, userName){
    activeUserId = userId;
    activeUserName = userName;
    userListUl.querySelectorAll('.user-list-item').forEach(i => i.classList.remove('active'));
    [...userListUl.querySelectorAll('.user-list-item')].find(i => i.dataset.userId===userId)?.classList.add('active');
    chatWithTitle.textContent = userName;
    chatInputForm.style.display = 'flex';
    chatInput.value = '';
    chatSendBtn.disabled = true;
    loadMessages(userId);
  }

  // Sohbeti kapatma
  closeChatBtn.addEventListener('click', () => {
    if(activeUserId) socket.emit('leave_room', {user_id:activeUserId, technician_id:'{{ TECHNICIAN_ID }}'});
    activeUserId = null;
    chatWithTitle.textContent = 'Bir kullanÄ±cÄ± seÃ§in';
    chatInputForm.style.display = 'none';
    messageListDiv.innerHTML = `
      <div class="empty-placeholder">
        <div class="placeholder-icon">ğŸ’¬</div>
        <div class="placeholder-text">KullanÄ±cÄ± seÃ§ildiÄŸinde mesajlar burada gÃ¶rÃ¼necek.</div>
      </div>`;
    userListUl.querySelectorAll('.user-list-item').forEach(i => i.classList.remove('active'));
  });

  // MesajlarÄ± yÃ¼kleme
  function loadMessages(userId){
    messageListDiv.innerHTML = '<div class="empty-placeholder">Mesajlar yÃ¼kleniyor...</div>';
    fetch(`/technician/messages/${userId}/get_messages`, { headers:{'X-Requested-With':'XMLHttpRequest'} })
      .then(res => res.json())
      .then(data => {
        if(!data.success) throw new Error('Mesajlar alÄ±namadÄ±');
        if(data.messages.length===0){
          messageListDiv.innerHTML = '<div class="empty-placeholder">HenÃ¼z mesaj yok.</div>'; 
          return;
        }
        let lastDate = '';
        let html = '';
        data.messages.forEach(msg => {
          const msgDate = msg.timestamp.split(' ')[0];
          if(msgDate !== lastDate){ html += `<div class="message-date-divider">${msgDate}</div>`; lastDate = msgDate; }
          html += `<div class="message-item ${msg.from_technician?'message-sender-tech':'message-sender-user'}">
                     ${escapeHtml(msg.body)}
                     <div class="message-meta">${msg.timestamp}</div>
                   </div>`;
        });
        messageListDiv.innerHTML = html;
        scrollToBottom();
      })
      .catch(err => {
        messageListDiv.innerHTML = '<div class="empty-placeholder text-danger">Mesajlar yÃ¼klenirken hata oluÅŸtu.</div>';
        console.error(err);
      });
  }

  // Mesaj input ve Enter kontrol
  chatInput.addEventListener('input', ()=>chatSendBtn.disabled = chatInput.value.trim() === '');
  chatInput.addEventListener('keydown', e => {
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); if(!chatSendBtn.disabled) chatSendBtn.click(); }
  });

  // Mesaj gÃ¶nderimi
  chatInputForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!activeUserId) return;
    const body = chatInput.value.trim();
    if(!body) return;
    chatSendBtn.disabled = true;

    const formData = new FormData();
    formData.append('user_id', activeUserId);
    formData.append('message_body', body);

    fetch("{{ url_for('technician_send_message') }}", {
      method:'POST',
      body: formData,
      headers:{'X-Requested-With':'XMLHttpRequest'}
    }).then(res=>res.json())
      .then(data=>{
        if(data.success){
          chatInput.value=''; chatSendBtn.disabled=true;
          appendMessage(body,true,'ÅŸimdi'); showToast(data.message,'success');
          updateUserListLastMessage(activeUserId,body,'ÅŸimdi',true);
        } else { chatSendBtn.disabled=false; showToast(data.message||'Mesaj gÃ¶nderilemedi','danger'); }
      }).catch(err=>{ chatSendBtn.disabled=false; showToast('Mesaj gÃ¶nderilemedi','danger'); console.error(err); });
  });

  // Socket.IO gelen mesaj
  socket.on('receive_message', data => {
    if(activeUserId === String(data.user_id)){
      appendMessage(data.body, data.from_technician, data.timestamp);
      updateUserListLastMessage(activeUserId, data.body, data.timestamp, false);
    } else {
      updateUserListLastMessage(data.user_id, data.body, data.timestamp, true);
    }
  });

  // Mesaj ekleme helper
  function appendMessage(body, fromTech, timestamp){
    const div = document.createElement('div');
    div.className = `message-item ${fromTech?'message-sender-tech':'message-sender-user'}`;
    div.innerHTML = `${escapeHtml(body)}<div class="message-meta">${timestamp}</div>`;
    messageListDiv.appendChild(div);
    scrollToBottom();
  }

  // KullanÄ±cÄ± listesi gÃ¼ncelleme
  function updateUserListLastMessage(userId,lastMsg,timestamp,incBadge){
    const item = [...userListUl.querySelectorAll('.user-list-item')].find(i=>i.dataset.userId===String(userId));
    if(item){
      item.querySelector('.user-last-message').textContent = lastMsg.length>30?lastMsg.substr(0,30)+'...':lastMsg;
      item.querySelector('.user-time').textContent = timestamp.split(' ')[1]||timestamp;
      const badge = item.querySelector('.user-unread-badge');
      if(incBadge) badge.classList.remove('d-none'), badge.textContent=(parseInt(badge.textContent||'0')+1);
      else badge.classList.add('d-none'), badge.textContent='0';
    }
  }

  // Scroll helper
  function scrollToBottom(){ messageListDiv.scrollTop = messageListDiv.scrollHeight; }

  // XSS escape
  function escapeHtml(text){ return text.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

  // Toast helper
  function showToast(msg,type='success'){
    const t=document.createElement('div');
    t.innerHTML = `<div class="toast align-items-center text-bg-${type} border-0 show mb-2 shadow" style="position:fixed;top:1rem;right:1rem;z-index:1055;">
                     <div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
                   </div>`;
    document.body.appendChild(t.firstElementChild);
    setTimeout(()=>{ const x=document.querySelector('.toast.show'); if(x) bootstrap.Toast.getOrCreateInstance(x).hide(); setTimeout(()=>x.remove(),300); },4000);
  }

})();
</script>
{% endblock %}

  

