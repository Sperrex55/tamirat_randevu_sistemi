{% extends "base_technician.html" %}

{% block title %}Mesajlar - Premium{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='technician_messages.css') }}" />
{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;">
      {% for category, message in messages %}
        <div class="toast align-items-center text-bg-{{ category }} border-0 show mb-2">
          <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="user-list-container">
  <!-- Kullanıcı Listesi -->
  <div class="user-list-wrapper">
    <div class="user-search">
      <input type="text" id="userSearchInput" placeholder="Kullanıcı ara..." />
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="var(--color-user-name-muted)" class="bi bi-search" viewBox="0 0 16 16">
        <path d="M11 6a5 5 0 1 1-1.018-3.218l3.85 3.85a1 1 0 0 1-1.414 1.414l-3.85-3.85A4.978 4.978 0 0 1 11 6z"/>
      </svg>
    </div>
    <div class="user-list">
      <ul id="userListUl">
        {% for user in users %}
        <li class="user-list-item" data-user-id="{{ user.id }}" data-user-name="{{ user.ad }} {{ user.soyad }}">
          <div class="d-flex align-items-center">
            <div class="avatar">{{ user.ad[0]|upper }}{{ user.soyad[0]|upper }}</div>
            <div class="user-name">{{ user.ad }} {{ user.soyad }}</div>
          </div>
          <button
            class="btn btn-sm btn-outline-primary btn-send-message"
            title="Mesaj Gönder"
            data-user-id="{{ user.id }}"
            data-user-name="{{ user.ad }} {{ user.soyad }}">
            <i class="bi bi-send-fill"></i>
          </button>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Mesajlaşma Alanı -->
  <div class="chat-area">
    <div class="chat-header" id="chatWithTitle">
      <span>Bir kullanıcı seçin</span>
      <button type="button" class="close-chat-btn" id="closeChatBtn" aria-label="Sohbeti Kapat">&times;</button>
    </div>

    <div class="message-list" id="messageList">
      <div class="empty-placeholder">Kullanıcı seçildiğinde mesajlar burada görünecek.</div>
    </div>

    <form id="chatInputForm" class="chat-input-area" style="display:none;" novalidate>
      <textarea id="chatInput" placeholder="Mesaj yazın..." rows="3" required></textarea>
      <button type="submit" disabled>Gönder</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(() => {
  // Element Seçimleri
  const userSearchInput = document.getElementById('userSearchInput');
  const userListUl = document.getElementById('userListUl');
  const userItems = userListUl.querySelectorAll('.user-list-item');
  const messageListDiv = document.getElementById('messageList');
  const chatWithTitle = document.getElementById('chatWithTitle').querySelector('span');
  const closeChatBtn = document.getElementById('closeChatBtn');
  const chatInputForm = document.getElementById('chatInputForm');
  const chatInput = document.getElementById('chatInput');
  const chatSendBtn = chatInputForm.querySelector('button[type="submit"]');

  let activeUserId = null;
  let activeUserName = null;

  // Kullanıcı Arama
  userSearchInput.addEventListener('input', () => {
    const filter = userSearchInput.value.toLowerCase();
    userItems.forEach(item => {
      const name = item.getAttribute('data-user-name').toLowerCase();
      item.style.display = name.includes(filter) ? '' : 'none';
    });
  });

  // Kullanıcı Seçimi
  userItems.forEach(item => {
    item.addEventListener('click', (e) => {
      // Mesaj gönderme butonu tıklaması ise
      if (e.target.closest('button.btn-send-message')) {
        e.stopPropagation();
        const userId = e.target.closest('button').getAttribute('data-user-id');
        const userName = e.target.closest('button').getAttribute('data-user-name');
        openSendMessage(userId, userName);
        return;
      }

      // Normal kullanıcı seçimi
      const userId = item.getAttribute('data-user-id');
      const userName = item.getAttribute('data-user-name');

      if (activeUserId === userId) return;

      setActiveUser(userId, userName);
    });
  });

  // Aktif Kullanıcıyı Set Et ve Mesajları Getir
  function setActiveUser(userId, userName) {
    activeUserId = userId;
    activeUserName = userName;

    userItems.forEach(i => i.classList.remove('active'));
    [...userItems].find(i => i.getAttribute('data-user-id') === userId)?.classList.add('active');

    chatWithTitle.textContent = `${userName} ile Mesajlaşma`;
    chatInputForm.style.display = 'flex';
    chatInput.value = '';
    chatSendBtn.disabled = true;

    loadMessages(userId);
  }

  // Sohbet Kapat
  closeChatBtn.addEventListener('click', () => {
    activeUserId = null;
    activeUserName = null;

    userItems.forEach(i => i.classList.remove('active'));
    chatWithTitle.textContent = 'Bir kullanıcı seçin';
    messageListDiv.innerHTML = '<div class="empty-placeholder">Kullanıcı seçildiğinde mesajlar burada görünecek.</div>';
    chatInputForm.style.display = 'none';
  });

  // Mesajları Yükle
  function loadMessages(userId) {
    messageListDiv.innerHTML = '<div class="empty-placeholder">Mesajlar yükleniyor...</div>';

    fetch(`/technician/messages/${userId}/get_messages`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => {
      if (!res.ok) throw new Error("Mesajlar alınamadı");
      return res.json();
    })
    .then(data => {
      if (!data.success) throw new Error(data.message || "Mesajlar alınamadı");

      if (data.messages.length === 0) {
        messageListDiv.innerHTML = `<div class="empty-placeholder">Henüz mesaj yok.</div>`;
        return;
      }

      let html = '';
      data.messages.forEach(msg => {
        html += `
          <div class="message-item ${msg.from_technician ? 'message-sender-tech' : 'message-sender-user'}">
            ${escapeHtml(msg.body)}
            <div class="message-meta">${msg.timestamp}</div>
          </div>`;
      });

      messageListDiv.innerHTML = html;

      // Scroll alta kaydır
      messageListDiv.scrollTop = messageListDiv.scrollHeight;
    })
    .catch(err => {
      messageListDiv.innerHTML = `<div class="empty-placeholder" style="color:#dc3545;">Mesajlar yüklenirken hata oluştu.</div>`;
      console.error(err);
    });
  }

  // Mesaj Yazma Alanı - Aktif/Deaktif Buton
  chatInput.addEventListener('input', () => {
    chatSendBtn.disabled = chatInput.value.trim().length === 0;
  });

  // Mesaj Gönderimi
  chatInputForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!activeUserId) return;

    const body = chatInput.value.trim();
    if (body.length === 0) return;

    chatSendBtn.disabled = true;

    const formData = new FormData();
    formData.append('user_id', activeUserId);
    formData.append('message_body', body);

    fetch("{{ url_for('technician_send_message') }}", {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => {
      if (!res.ok) throw new Error("Mesaj gönderilemedi");
      return res.json();
    })
    .then(data => {
      if (data.success) {
        chatInput.value = '';
        chatSendBtn.disabled = true;

        // Mesajı Listeye Ekleyip Alta Kaydır
        const newMessage = document.createElement('div');
        newMessage.className = 'message-item message-sender-tech';
        newMessage.innerHTML = `
          ${escapeHtml(body)}
          <div class="message-meta">şimdi</div>
        `;
        messageListDiv.appendChild(newMessage);
        messageListDiv.scrollTop = messageListDiv.scrollHeight;

        showToast(data.message, 'success');
      } else {
        showToast(data.message || "Mesaj gönderilemedi", 'danger');
        chatSendBtn.disabled = false;
      }
    })
    .catch(err => {
      console.error(err);
      showToast("Mesaj gönderilemedi", 'danger');
      chatSendBtn.disabled = false;
    });
  });

  // Modal değil, direk sayfa içi sohbet aç
  function openSendMessage(userId, userName) {
    setActiveUser(userId, userName);
    chatInput.focus();
  }

  // XSS için HTML Escape
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

  // Toast Göster
  function showToast(message, type = 'success') {
    const toastHTML = `
      <div class="toast align-items-center text-bg-${type} border-0 show mb-2 shadow" 
           style="z-index: 1055; position: fixed; top: 1rem; right: 1rem;">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`;
    const toastElem = document.createElement('div');
    toastElem.innerHTML = toastHTML;
    document.body.appendChild(toastElem.firstElementChild);

    // Otomatik kaybolma
    setTimeout(() => {
      const toast = document.querySelector('.toast.show');
      if (toast) {
        bootstrap.Toast.getOrCreateInstance(toast).hide();
        setTimeout(() => toast.remove(), 300);
      }
    }, 4000);
  }

})();
</script>
{% endblock %}
