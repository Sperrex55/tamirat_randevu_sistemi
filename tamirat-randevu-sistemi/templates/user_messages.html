{% extends "base_user.html" %}
{% block title %}Mesajlar{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='user_messages.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
{% endblock %}

{% block content %}

<div class="chat-container">
    <!-- Sol panel: Tekniker listesi -->
    <div class="tech-list">
        <div class="search-wrapper">
            <input type="text" id="techSearch" placeholder="Tekniker ara..." />
            <i class="bi bi-search search-icon"></i>
        </div>
        <ul id="techListUl">
            {% for tech in technicians %}
            <li class="tech-item" data-tech-id="{{ tech.id }}">
    <div class="tech-avatar">{{ tech.ad[0]|upper }}{{ tech.soyad[0]|upper }}</div>
    <div class="tech-info">
        <span class="tech-name">
            {{ tech.ad }} {{ tech.soyad[:2]|upper }}{% for i in range(tech.soyad|length - 2) %}*{% endfor %}
        </span>
        <span class="tech-status">√áevrimi√ßi</span>
    </div>
</li>

            {% endfor %}
        </ul>
    </div>

    <!-- Saƒü panel: Mesaj alanƒ± -->
    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="chat-avatar"></div>
                <span id="chatWithTitle">Bir tekniker se√ßin</span>
            </div>
            <span id="closeChat" title="Sohbeti kapat">‚úï</span>
        </div>
        <div class="message-list" id="messageList">
            <div class="empty-placeholder">
  <div class="placeholder-icon">üí¨</div>
  <div class="placeholder-text">
    Tekniker se√ßildiƒüinde mesajlar burada g√∂r√ºnecek.
  </div>
</div>
        </div>
        <form id="chatInputForm" class="chat-input-area" style="display:none;" novalidate>
            <textarea id="chatInput" placeholder="Mesaj yazƒ±n..." rows="1" required></textarea>
            <button type="submit" disabled><i class="bi bi-send-fill"></i></button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
let activeTechId = null;
const userId = parseInt("{{ current_user.get_id().split('-')[1] }}");

const techListUl = document.getElementById('techListUl');
const techItems = techListUl.querySelectorAll('.tech-item');
const messageListDiv = document.getElementById('messageList');
const chatInputForm = document.getElementById('chatInputForm');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = chatInputForm.querySelector('button');
const closeChatBtn = document.getElementById('closeChat');

function escapeHtml(text){
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' };
    return text.replace(/[&<>"']/g, m=>map[m]);
}

function appendMessage(message, fromUser){
    const div = document.createElement('div');
    div.className = fromUser ? 'message-sender-user' : 'message-sender-tech';
    div.innerHTML = `
        <div class="message-body">${escapeHtml(message.body)}</div>
        <div class="timestamp">${message.timestamp}</div>
    `;
    messageListDiv.appendChild(div);
    messageListDiv.scrollTop = messageListDiv.scrollHeight;
}

// Tekniker se√ßimi
techItems.forEach(item => {
    item.addEventListener('click', () => {
        techItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        activeTechId = parseInt(item.getAttribute('data-tech-id'));
        document.getElementById('chatWithTitle').textContent =
            item.querySelector('.tech-name').textContent + " ile Mesajla≈üma";

        chatInputForm.style.display = 'flex';
        chatInput.value = '';
        chatSendBtn.disabled = true;

        loadMessages(activeTechId);
        socket.emit('join_room', { user_id: userId, technician_id: activeTechId });
    });
});

// Sohbeti kapatma
closeChatBtn.addEventListener('click', () => {
    chatInputForm.style.display = 'none';
    messageListDiv.innerHTML = `
        <div class="empty-placeholder">
            <div class="placeholder-icon">üí¨</div>
            <div class="placeholder-text">Tekniker se√ßildiƒüinde mesajlar burada g√∂r√ºnecek.</div>
        </div>
    `;
    if (activeTechId) {
        socket.emit('leave_room', { user_id: userId, technician_id: activeTechId });
    }
    activeTechId = null;
    document.getElementById('chatWithTitle').textContent = 'Bir tekniker se√ßin';
    techItems.forEach(item => item.classList.remove('active'));
});

// Mesajlarƒ± y√ºkleme
function loadMessages(tech_id){
    fetch(`/user/messages/${tech_id}/get_messages`)
    .then(res => res.json())
    .then(data => {
        messageListDiv.innerHTML = '';
        if(data.messages.length === 0){
            messageListDiv.innerHTML = '<div class="empty-placeholder">Hen√ºz mesaj yok.</div>';
            return;
        }
        data.messages.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        data.messages.forEach(m => appendMessage(m, m.from_user));
    });
}

// Mesaj yazma ve g√∂nderme
chatInput.addEventListener('input', ()=> chatSendBtn.disabled = chatInput.value.trim() === '');
chatInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        if(!chatSendBtn.disabled) chatSendBtn.click();
    }
});

chatInputForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!activeTechId) return;

    const messageText = chatInput.value.trim();
    if(!messageText) return;

    // Backend‚Äôe kaydetme
    fetch(`/user/messages/${activeTechId}/send`, {
        method: 'POST',
        body: new URLSearchParams({ 
            message_body: messageText,
            user_id: activeTechId   // ‚ö† user_id ekledik
        }),
        headers: {'X-Requested-With':'XMLHttpRequest'}
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            chatInput.value = '';
            chatSendBtn.disabled = true;

            // Socket ile anlƒ±k g√∂nder
            socket.emit('send_message', {
                user_id: userId,
                technician_id: activeTechId,
                body: messageText,
                sender_type: 'user'
            });
        } else {
            alert(data.message);
        }
    });
});

// Socket.IO: Gelen mesajlarƒ± ekle
socket.on('receive_message', data => {
    if(!activeTechId) return;
    if(data.technician_id === activeTechId && data.user_id === userId){
        appendMessage({body: data.body, timestamp: data.timestamp}, data.sender_type === 'user');
    }
});

// Tekniker arama
document.getElementById('techSearch').addEventListener('input', ()=> {
    const filter = document.getElementById('techSearch').value.toLowerCase();
    techItems.forEach(item => {
        const name = item.querySelector('.tech-name').textContent.toLowerCase();
        item.style.display = name.includes(filter) ? '' : 'none';
    });
});
</script>
{% endblock %}




