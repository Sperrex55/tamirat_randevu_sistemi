{% extends "base_user.html" %}
{% block title %}Mesajlar{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='user_messages.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sol panel: Tekniker listesi -->
    <div class="tech-list">
        <div class="search-wrapper">
            <input type="text" id="techSearch" placeholder="Tekniker ara..." />
            <i class="bi bi-search search-icon"></i>
        </div>
        <ul id="techListUl">
            {% for tech in technicians %}
            <li class="tech-item" data-tech-id="{{ tech.id }}">
                <div class="tech-avatar">{{ tech.ad[0]|upper }}{{ tech.soyad[0]|upper }}</div>
                <span class="tech-name">{{ tech.ad }} {{ tech.soyad }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Sağ panel: Mesaj alanı -->
    <div class="chat-area">
        <div class="chat-header">
            <span id="chatWithTitle">Bir tekniker seçin</span>
            <span id="closeChat" title="Sohbeti kapat">✕</span>
        </div>
        <div class="message-list" id="messageList">
            <div class="empty-placeholder">Tekniker seçildiğinde mesajlar burada görünecek.</div>
        </div>
        <form id="chatInputForm" class="chat-input-area" style="display:none;" novalidate>
            <textarea id="chatInput" placeholder="Mesaj yazın..." rows="1" required></textarea>
            <button type="submit" disabled>Gönder</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const socket = io(); // Socket.IO bağlantısı
let activeTechId = null;

const techListUl = document.getElementById('techListUl');
const techItems = techListUl.querySelectorAll('.tech-item');
const messageListDiv = document.getElementById('messageList');
const chatInputForm = document.getElementById('chatInputForm');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = chatInputForm.querySelector('button');
const closeChatBtn = document.getElementById('closeChat');

// XSS güvenliği için escape fonksiyonu
function escapeHtml(text){
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' };
    return text.replace(/[&<>"']/g, m=>map[m]);
}

// Mesaj ekleme fonksiyonu
function appendMessage(message, fromUser){
    const div = document.createElement('div');
    div.className = fromUser ? 'message-sender-user' : 'message-sender-tech';
    div.innerHTML = `
        <div class="message-body">${escapeHtml(message.body)}</div>
        <div class="timestamp">${message.timestamp}</div>
    `;
    messageListDiv.appendChild(div);

    // Scroll her zaman en alta
    messageListDiv.scrollTop = messageListDiv.scrollHeight;
}

// Tekniker seçimi
techItems.forEach(item => {
    item.addEventListener('click', () => {
        techItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        activeTechId = parseInt(item.getAttribute('data-tech-id'));
        document.getElementById('chatWithTitle').textContent =
            item.querySelector('.tech-name').textContent + " ile Mesajlaşma";

        chatInputForm.style.display = 'flex';
        chatInput.value = '';
        chatSendBtn.disabled = true;

        loadMessages(activeTechId);
        socket.emit('join_room', { tech_id: activeTechId });
    });
});

// Sohbet kapatma
closeChatBtn.addEventListener('click', ()=> {
    chatInputForm.style.display = 'none';
    messageListDiv.innerHTML = '<div class="empty-placeholder">Tekniker seçildiğinde mesajlar burada görünecek.</div>';
    activeTechId = null;
    document.getElementById('chatWithTitle').textContent = 'Bir tekniker seçin';
    techItems.forEach(i => i.classList.remove('active'));
});

// Mesajları yükleme
function loadMessages(tech_id){
    fetch(`/user/messages/${tech_id}/get_messages`)
    .then(res => res.json())
    .then(data => {
        messageListDiv.innerHTML = '';

        if(data.messages.length === 0){
            messageListDiv.innerHTML = '<div class="empty-placeholder">Henüz mesaj yok.</div>';
            return;
        }

        // Kronolojik sıraya göre ekle
        data.messages.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        data.messages.forEach(m => appendMessage(m, m.from_user));
    });
}

// Mesaj yazma ve gönderme
chatInput.addEventListener('input', ()=> chatSendBtn.disabled = chatInput.value.trim() === '');

chatInputForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!activeTechId) return;

    const messageText = chatInput.value.trim();
    if(!messageText) return;

    const fd = new FormData();
    fd.append('message_body', messageText);

    fetch(`/user/messages/${activeTechId}/send`, {method:'POST', body:fd})
    .then(res => res.json())
    .then(data => {
        if(data.success){
            chatInput.value='';
            chatSendBtn.disabled = true;

            // Kullanıcı mesajını anında ekle
            const timestamp = new Date().toLocaleString();
            appendMessage({body: messageText, timestamp: timestamp}, true);
        } else {
            alert(data.message);
        }
    });
});

// Socket.IO: Gelen yeni mesajı ekleme
socket.on('receive_message', data => {
    if(!activeTechId) return;
    if(parseInt(activeTechId) === data.tech_id || parseInt(activeTechId) === data.user_id){
        appendMessage({body: data.body, timestamp: data.timestamp}, data.from_user);
    }
});

// Tekniker arama
document.getElementById('techSearch').addEventListener('input', ()=> {
    const filter = document.getElementById('techSearch').value.toLowerCase();
    techItems.forEach(item => {
        const name = item.querySelector('.tech-name').textContent.toLowerCase();
        item.style.display = name.includes(filter) ? '' : 'none';
    });
});
</script>



{% endblock %}
