{% extends "base_user.html" %}
{% block title %}RandevularÄ±m{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='user_appointments.css') }}">
<style>
  /* DARK MODE STYLES */
  [data-bs-theme="dark"] body {
    background-color: #121212;
    color: #e0e0e0;
  }

  [data-bs-theme="dark"] .container {
    color: #ddd;
  }

  [data-bs-theme="dark"] h2 {
    color: #7dafff;
  }

  [data-bs-theme="dark"] .alert-info {
    background-color: #222;
    color: #ccc;
    border-color: #444;
  }

  [data-bs-theme="dark"] table {
    background-color: #1e1e1e;
    color: #ddd;
    border-color: #444;
  }

  [data-bs-theme="dark"] thead.table-primary {
    background-color: #2a2a2a !important;
    color: #7dafff !important;
  }

  [data-bs-theme="dark"] tbody tr {
    border-bottom: 1px solid #444;
  }

  [data-bs-theme="dark"] tbody tr:hover {
    background-color: #333;
  }

  [data-bs-theme="dark"] .badge.bg-info {
    background-color: #4dabf7 !important;
    color: #222 !important;
  }

  [data-bs-theme="dark"] .badge.bg-success {
    background-color: #198754 !important;
  }

  [data-bs-theme="dark"] .badge.bg-warning {
    background-color: #ffc107 !important;
    color: #222 !important;
  }

  [data-bs-theme="dark"] .badge.bg-danger {
    background-color: #dc3545 !important;
  }

  [data-bs-theme="dark"] .badge.bg-secondary {
    background-color: #6c757d !important;
  }

  [data-bs-theme="dark"] .btn-primary {
    background-color: #4e54c8;
    border-color: #4e54c8;
    color: white;
  }

  [data-bs-theme="dark"] .btn-primary:hover {
    background-color: #6f73e5;
    border-color: #6f73e5;
  }

  /* Scrollbar for description overflow in dark mode */
  [data-bs-theme="dark"] td[style*="overflow-y: auto"]::-webkit-scrollbar {
    width: 6px;
  }
  [data-bs-theme="dark"] td[style*="overflow-y: auto"]::-webkit-scrollbar-thumb {
    background-color: #555;
    border-radius: 3px;
  }
</style>
{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;">
      {% for category, message in messages %}
        <div class="toast align-items-center text-bg-{{ category }} border-0 show mb-2">
          <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="container mt-4">
  <h2 class="mb-4">ðŸ“… RandevularÄ±m</h2>

  <div id="alert-no-appointments" class="alert alert-info" role="alert" style="display:none;">
    HenÃ¼z randevunuz bulunmamaktadÄ±r.
  </div>

  <div class="table-responsive" id="appointments-table-container" style="display:none;">
    <table class="table table-hover table-bordered align-middle shadow-sm rounded-4 overflow-hidden" id="appointments-table">
      <thead class="table-primary">
        <tr>
          <th scope="col">Tarih</th>
          <th scope="col">UzmanlÄ±k</th>
          <th scope="col">Kategori</th>
          <th scope="col">AÃ§Ä±klama</th>
          <th scope="col">Durum</th>
          <th scope="col">Ä°ÅŸlem</th>
        </tr>
      </thead>
      <tbody id="appointments-tbody">
        <!-- Buraya AJAX ile gelecek randevular yazÄ±lacak -->
      </tbody>
    </table>
  </div>
</div>

<script>
async function fetchAppointments() {
  try {
    const res = await fetch("{{ url_for('api_user_appointments_status') }}");
    if (!res.ok) throw new Error("Veri alÄ±namadÄ±");

    const data = await res.json();
    const tbody = document.getElementById('appointments-tbody');
    const tableContainer = document.getElementById('appointments-table-container');
    const noAppointmentsAlert = document.getElementById('alert-no-appointments');

    if (data.appointments.length === 0) {
      tableContainer.style.display = 'none';
      noAppointmentsAlert.style.display = 'block';
      tbody.innerHTML = '';
      return;
    }

    noAppointmentsAlert.style.display = 'none';
    tableContainer.style.display = 'block';

    tbody.innerHTML = '';

    data.appointments.forEach(appt => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><i class="bi bi-calendar-event"></i> ${appt.date}</td>
        <td>${appt.uzmanlik}</td>
        <td><span class="badge bg-info text-dark">${appt.category}</span></td>
        <td style="max-height: 80px; overflow-y: auto; white-space: normal; max-width: 300px;">${appt.description}</td>
        <td>
          ${appt.status === 'OnaylandÄ±' ? '<span class="badge bg-success">OnaylandÄ±</span>' : ''}
          ${appt.status === 'Beklemede' ? '<span class="badge bg-warning text-dark">Beklemede</span>' : ''}
          ${appt.status === 'Ä°ptal Edildi' ? '<span class="badge bg-danger">Ä°ptal Edildi</span>' : ''}
          ${appt.status === 'Tekniker Bekliyor' ? '<span class="badge bg-secondary">Tekniker Bekliyor</span>' : ''}
        </td>
        <td>
          <a href="/user/appointment/edit/${appt.id}" class="btn btn-sm btn-primary">
            <i class="bi bi-pencil-square"></i> DÃ¼zenle
          </a>
        </td>
      `;

      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error(error);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  fetchAppointments();
  setInterval(fetchAppointments, 5000);  // 5 saniyede bir yenile
});
</script>

{% endblock %}
