{% extends "base_admin.html" %}

{% block title %}Randevu Yönetimi - Admin Paneli{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
<style>
  body {
    background-color: #f8f9fa;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .table-responsive {
    background: #fff;
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    padding: 1rem;
  }
  tbody tr:hover {
    background-color: #eef6ff;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  .btn i { vertical-align: middle; font-size: 1.1rem; }
  .modal-content {
    border-radius: 0.75rem;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }
  .bg-gradient-primary {
    background: linear-gradient(135deg, #0d6efd, #6610f2);
  }
</style>
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;">
      {% for category, message in messages %}
        <div class="toast align-items-center text-bg-{{ category }} border-0 show mb-2">
          <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="container mt-5 px-3 px-md-0">
  <h2 class="mb-4 text-center fw-bold">Randevu Yönetimi</h2>

  <div class="table-responsive">
    <table id="appointmentsTable" class="table table-striped table-hover align-middle mb-0">
      <thead class="table-primary text-primary text-uppercase">
        <tr>
          <th>ID</th>
          <th>Kullanıcı</th>
          <th>Tekniker</th>
          <th>Tarih</th>
          <th>Durum</th>
          <th>İşlemler</th>
        </tr>
      </thead>
      <tbody>
        {% for appointment in appointments %}
        <tr>
          <td>{{ appointment.id }}</td>
          <td>{{ appointment.user.ad }} {{ appointment.user.soyad }}</td>
          <td>
            {% if appointment.technician %}
              {{ appointment.technician.ad }} {{ appointment.technician.soyad }}
            {% else %}
              <span class="text-muted fst-italic">Atanmadı</span>
            {% endif %}
          </td>
          <td>{{ appointment.date.strftime('%d.%m.%Y') }}</td>
          <td>
            {% if appointment.status == 'Onaylandı' %}
              <span class="badge bg-success">Onaylandı</span>
            {% elif appointment.status == 'İptal Edildi' %}
              <span class="badge bg-danger">İptal Edildi</span>
            {% else %}
              <span class="badge bg-warning text-dark">Beklemede</span>
            {% endif %}
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-info me-1"
              data-bs-toggle="modal" data-bs-target="#appointmentModal"
              data-id="{{ appointment.id }}"
              data-user="{{ appointment.user.ad }} {{ appointment.user.soyad }}"
              data-technician="{% if appointment.technician %}{{ appointment.technician.ad }} {{ appointment.technician.soyad }}{% else %}Atanmadı{% endif %}"
              data-date="{{ appointment.date.strftime('%d.%m.%Y') }}"
              data-status="{{ appointment.status }}"
              data-description="{{ appointment.description }}">
              <i class="bi bi-eye"></i>
            </button>

            <button type="button" class="btn btn-sm btn-outline-danger"
              data-bs-toggle="modal"
              data-bs-target="#cancelAppointmentModal"
              data-id="{{ appointment.id }}"
              data-user="{{ appointment.user.ad }} {{ appointment.user.soyad }}"
              {% if appointment.status == 'İptal Edildi' %}disabled{% endif %}>
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="text-center py-4">Kayıtlı randevu bulunmamaktadır.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Detay Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-gradient-primary text-white">
        <h5 class="modal-title"><i class="bi bi-calendar-event me-2"></i>Randevu Detayları</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-unstyled mb-0">
          <li><strong>ID:</strong> <span id="modalAppointmentId"></span></li>
          <li><strong>Kullanıcı:</strong> <span id="modalUserName"></span></li>
          <li><strong>Tekniker:</strong> <span id="modalTechnicianName"></span></li>
          <li><strong>Tarih:</strong> <span id="modalDate"></span></li>
          <li><strong>Durum:</strong> <span id="modalStatus" class="badge rounded-pill px-3 py-1"></span></li>
          <li><strong>Açıklama:</strong> <p id="modalDescription" class="mb-0"></p></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- İptal Modal -->
<div class="modal fade" id="cancelAppointmentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Randevu İptali</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center fs-5">
        <p><strong id="cancelUserName"></strong> adlı kullanıcının randevusunu iptal etmek istediğinize emin misiniz?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Vazgeç</button>
        <form id="cancelAppointmentForm" method="POST">
          <button type="submit" class="btn btn-danger">Evet, İptal Et</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
  $('#appointmentsTable').DataTable({
    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' },
    pageLength: 10
  });

  var detailModal = document.getElementById('appointmentModal');
  detailModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    document.getElementById('modalAppointmentId').innerText = button.getAttribute('data-id');
    document.getElementById('modalUserName').innerText = button.getAttribute('data-user');
    document.getElementById('modalTechnicianName').innerText = button.getAttribute('data-technician');
    document.getElementById('modalDate').innerText = button.getAttribute('data-date');
    document.getElementById('modalDescription').innerText = button.getAttribute('data-description');

    var statusSpan = document.getElementById('modalStatus');
    var statusValue = button.getAttribute('data-status').toLowerCase();
    statusSpan.className = 'badge rounded-pill px-3 py-1';
    if (statusValue.includes('onay')) {
      statusSpan.classList.add('bg-success');
      statusSpan.innerText = 'Onaylandı';
    } else if (statusValue.includes('iptal')) {
      statusSpan.classList.add('bg-danger');
      statusSpan.innerText = 'İptal Edildi';
    } else {
      statusSpan.classList.add('bg-warning', 'text-dark');
      statusSpan.innerText = 'Beklemede';
    }
  });

  var cancelModal = document.getElementById('cancelAppointmentModal');
  cancelModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var id = button.getAttribute('data-id');
    var user = button.getAttribute('data-user');
    document.getElementById('cancelUserName').textContent = user;
    var actionUrl = "{{ url_for('admin_cancel_appointment', appointment_id=0) }}".replace('0', id);
    document.getElementById('cancelAppointmentForm').action = actionUrl;
  });
});
</script>
{% endblock %}
