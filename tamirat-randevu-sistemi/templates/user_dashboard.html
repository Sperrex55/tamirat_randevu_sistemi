{% extends "base_user.html" %}

{% block title %}Üye Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='user_dashboard.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}

{% block content %}

<!-- TOAST MESAJLAR -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055; min-width: 300px;">
      {% for category, message in messages %}
        <div class="toast align-items-center text-bg-{{ category }} border-0 show mb-2 shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3500">
          <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="container mt-5">

  <!-- KARŞILAMA -->
  <div class="text-center mb-5">
    <h2 class="fw-bold">👋 Hoşgeldiniz, <span class="text-primary">{{ user.ad }} {{ user.soyad }}</span></h2>
    <p class="text-muted fs-5">
  Randevularınızı planlayın, mesajlarınızı görüntüleyin ve servis süreçlerinizi kolayca yönetin. Tek bir panelden her şey kontrolünüz altında.
</p>

  </div>

<!-- ✅ KPI KARTLARI -->
<div class="row g-4 mb-5">
  {% for stat in [
    {'icon': 'calendar-check-fill', 'variant': 'primary', 'title': 'Toplam Randevu', 'value': total_appointments},
    {'icon': 'check-circle-fill', 'variant': 'success', 'title': 'Onaylanan Randevu', 'value': completed_appointments},
    {'icon': 'envelope-fill', 'variant': 'danger', 'title': 'Yeni Mesaj', 'value': messages_count}
  ] %}
  <div class="col-12 col-md-6 col-lg-4">
    <div class="card border-0 rounded-4 stat-card {{ stat.variant }} h-100">
      <div class="card-body text-center p-4">
        
        <!-- İkon kutusu -->
        <div class="icon-ring mb-3">
          <i class="bi bi-{{ stat.icon }}"></i>
        </div>

        <!-- Değer -->
        <h2 class="value">{{ stat.value }}</h2>
        
        <!-- Başlık -->
        <p class="label">{{ stat.title }}</p>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

  <!-- MINI GRAFIK -->
  <h3 class="mt-5 mb-3 fw-bold border-start border-4 border-success ps-3">📊 Aylık Randevu Trendiniz</h3>
<canvas id="appointmentsChart" height="110"></canvas>

<!-- 📢 DUYURULAR -->
<h3 class="mt-5 mb-4 fw-bold border-start border-4 border-primary ps-3">📢 Aktif Duyurular</h3>

{% if announcements %}
  <div class="row g-4">
    {% for duyuru in announcements %}
      <!-- 🔔 DUYURU KARTI -->
      <div class="col-12">
        <div class="card border-0 shadow-sm rounded-4 p-4 announcement-card">
          <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
            <h5 class="fw-semibold mb-0 text-primary d-flex align-items-center flex-grow-1 flex-shrink-1">
              <i class="bi bi-megaphone-fill me-2 fs-4"></i> {{ duyuru.title }}
            </h5>
            <small class="text-muted fst-italic ms-auto flex-shrink-0">
              {{ duyuru.date_created.strftime('%d.%m.%Y %H:%M') }}
            </small>
          </div>
          <p class="text-secondary announcement-content mb-0">
            {{ duyuru.content }}
          </p>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info d-flex align-items-center gap-3 rounded-4 shadow-sm" role="alert">
    <i class="bi bi-info-circle-fill fs-4"></i>
    <span>Henüz duyuru bulunmamaktadır.</span>
  </div>
{% endif %}



  <!-- SON RANDEVULAR -->
  <h3 class="mt-5 mb-3 fw-bold border-start border-4 border-success ps-3">📅 Son Randevularınız</h3>
  
  {% if recent_appointments %}
    <div class="list-group" id="appointmentsList">
      {% for randevu in recent_appointments %}
        {% set status_class = 'success' if randevu.status.lower() == 'tamamlandı' else 'warning' %}
        <a href="{{ url_for('edit_user_appointment', id=randevu.id) }}" 
           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center hover-shadow rounded-4 mb-2 {% if randevu.status.lower() == 'onaylandı' %}disabled{% endif %}"
           tabindex="0"
           role="button"
           aria-label="Randevu: {{ randevu.category }} - {{ randevu.uzmanlik }} - {{ randevu.date.strftime('%d.%m.%Y') }}">
          <div>
            <strong>{{ randevu.date.strftime('%d.%m.%Y') }}</strong> - {{ randevu.category }} / {{ randevu.uzmanlik }}
            <br>
            <small class="text-muted">{{ randevu.destek_modeli or 'Belirtilmedi' }} - {{ randevu.description[:50] }}{% if randevu.description|length > 50 %}...{% endif %}</small>
          </div>
          <span class="badge bg-{{ status_class }}">{{ randevu.status }}</span>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning" role="alert">
      Henüz kayıtlı randevunuz bulunmamaktadır.
    </div>
  {% endif %}

</div>

  <!-- JS -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // TOAST
    const toastElList = [].slice.call(document.querySelectorAll('.toast'));
    toastElList.forEach(toastEl => new bootstrap.Toast(toastEl).show());

   

    // CHART
    const ctx = document.getElementById('appointmentsChart').getContext('2d');

    // Flask'den gelen değişkenleri JSON.parse ile güvenli JS array'e çeviriyoruz
    const labels = JSON.parse('{{ monthly_labels|tojson|safe }}');
    const dataValues = JSON.parse('{{ monthly_values|tojson|safe }}');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Randevular',
          data: dataValues,
          fill: true,
          backgroundColor: 'rgba(13,110,253,0.1)',
          borderColor: 'rgba(13,110,253,1)',
          tension: 0.4,
          pointBackgroundColor: 'rgba(13,110,253,1)',
          pointHoverRadius: 6,
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        interaction: { mode: 'nearest', axis: 'x', intersect: false },
        scales: {
          y: { beginAtZero: true, precision:0, ticks: { stepSize: 1 } },
          x: { grid: { display: false } }
        }
      }
    });
  });


  
  </script>

{% endblock %}
