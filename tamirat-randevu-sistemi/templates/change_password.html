{% extends "base_user.html" %}

{% block title %}Şifre Değiştir{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='change_password.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 500px;">
  <div class="card card-premium">
    <div class="card-body p-4">

      <h3 class="mb-4 text-center">
        <i class="bi bi-shield-lock-fill tech-icon me-2"></i>Şifre Değiştir
      </h3>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;">
            {% for category, message in messages %}
              <div class="toast align-items-center text-bg-{{ category }} border-0 show mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                  <div class="toast-body">{{ message }}</div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <form method="POST" action="{{ url_for('change_password') }}" novalidate>
        <div class="mb-3">
          <label for="current_password" class="form-label">
            <i class="bi bi-key-fill me-1"></i>Mevcut Şifre
          </label>
          <input type="password" class="form-control" id="current_password" name="current_password" placeholder="Mevcut şifrenizi giriniz" required>
        </div>

        <div class="mb-3">
          <label for="new_password" class="form-label">
            <i class="bi bi-lock-fill me-1"></i>Yeni Şifre
          </label>
          <input type="password" class="form-control" id="new_password" name="new_password" placeholder="Yeni şifrenizi giriniz" required>
          <div id="password-strength" class="password-strength"></div>
          <div class="progress">
            <div id="password-bar" class="progress-bar" role="progressbar"></div>
          </div>
        </div>

        <div class="mb-4">
          <label for="confirm_password" class="form-label">
            <i class="bi bi-check2-circle me-1"></i>Yeni Şifre (Tekrar)
          </label>
          <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="Yeni şifreyi tekrar giriniz" required>
          <div id="password-match" class="password-strength"></div>
        </div>

        <button type="submit" class="btn btn-premium w-100 rounded-3 py-2">
          <i class="bi bi-arrow-repeat me-2"></i> Şifreyi Güncelle
        </button>
      </form>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const newPassword = document.getElementById('new_password');
  const confirmPassword = document.getElementById('confirm_password');
  const strengthText = document.getElementById('password-strength');
  const matchText = document.getElementById('password-match');
  const passwordBar = document.getElementById('password-bar');

  function checkStrength(password) {
    let strengthScore = 0;
    if (password.length >= 6) strengthScore++;
    if (password.length >= 8) strengthScore++;
    if (/[A-Z]/.test(password)) strengthScore++;
    if (/[0-9]/.test(password)) strengthScore++;
    if (/[^A-Za-z0-9]/.test(password)) strengthScore++;
    return strengthScore;
  }

  newPassword.addEventListener('input', function() {
    const val = newPassword.value;
    const score = checkStrength(val);

    let strength = "";
    let className = "";
    let barWidth = 0;
    let barColor = "#dc3545";

    switch(score) {
      case 0:
      case 1:
        strength = "Zayıf";
        className = "strength-weak";
        barWidth = 20;
        barColor = "#dc3545";
        break;
      case 2:
      case 3:
        strength = "Orta";
        className = "strength-medium";
        barWidth = 60;
        barColor = "#fd7e14";
        break;
      case 4:
      case 5:
        strength = "Güçlü";
        className = "strength-strong";
        barWidth = 100;
        barColor = "#28a745";
        break;
    }

    strengthText.textContent = `Şifre Gücü: ${strength}`;
    strengthText.className = `password-strength ${className}`;
    passwordBar.style.width = barWidth + "%";
    passwordBar.style.backgroundColor = barColor;
  });

  confirmPassword.addEventListener('input', function() {
    if (confirmPassword.value && confirmPassword.value !== newPassword.value) {
      matchText.textContent = "Şifreler uyuşmuyor";
      matchText.className = "password-strength strength-weak";
    } else if (confirmPassword.value) {
      matchText.textContent = "Şifreler eşleşiyor";
      matchText.className = "password-strength strength-strong";
    } else {
      matchText.textContent = "";
      matchText.className = "password-strength";
    }
  });
});
</script>
{% endblock %}
